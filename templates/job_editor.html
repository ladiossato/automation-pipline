<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ 'Edit' if job else 'New' }} Job - Automation Platform</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>{{ 'Edit' if job else 'New' }} Job</h1>
            <p class="subtitle">Configure OCR extraction job</p>
        </header>

        <nav>
            <a href="/">Dashboard</a>
            <a href="/job/new" class="{{ 'active' if not job else '' }}">New Job</a>
        </nav>

        <form id="jobForm" class="job-form">
            <!-- Basic Settings -->
            <section class="form-section">
                <h2>Basic Settings</h2>

                <div class="form-group">
                    <label for="name">Job Name *</label>
                    <input type="text" id="name" name="name" required
                           value="{{ job.name if job else '' }}"
                           placeholder="e.g., stock_prices_monitor">
                </div>

                <div class="form-group">
                    <label for="url">Target URL *</label>
                    <input type="url" id="url" name="url" required
                           value="{{ job.url if job else '' }}"
                           placeholder="https://example.com/page">
                    <small>The page you want to extract data from</small>
                </div>
            </section>

            <!-- Pre-Extraction Actions -->
            <section class="form-section">
                <h2>Pre-Extraction Actions</h2>
                <p class="section-help">Define actions to execute before capturing data (e.g., click a tab, button, or menu item to reach the correct view)</p>

                <div id="actionsList" class="actions-list">
                    <!-- Actions will be rendered here -->
                </div>

                <div class="action-buttons">
                    <button type="button" class="btn" onclick="showAddActionModal()">
                        + Add Action
                    </button>
                    <button type="button" class="btn" onclick="testAllActions()" id="testAllActionsBtn" style="display: none;">
                        Test All Actions
                    </button>
                </div>
            </section>

            <!-- Action Modal -->
            <div id="actionModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="actionModalTitle">Add Action</h3>
                        <button type="button" class="modal-close" onclick="closeActionModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="actionType">Action Type</label>
                            <select id="actionType" onchange="updateActionForm()">
                                <option value="click_coordinates">Click at Coordinates</option>
                                <option value="click_ocr">Click Element by Text (OCR)</option>
                                <option value="wait">Wait (seconds)</option>
                                <option value="scroll">Scroll Page</option>
                                <option value="press_key">Press Keyboard Key</option>
                            </select>
                        </div>

                        <div id="actionFormFields">
                            <!-- Dynamic form fields will be inserted here -->
                        </div>

                        <div class="form-group">
                            <label for="actionWaitAfter">Wait After Action (seconds)</label>
                            <input type="number" id="actionWaitAfter" value="2" min="0" step="0.5">
                            <small>Time to wait after this action completes</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn" onclick="closeActionModal()">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="testCurrentAction()">Test Action</button>
                        <button type="button" class="btn btn-success" onclick="saveAction()">Save Action</button>
                    </div>
                </div>
            </div>

            <!-- OCR Regions -->
            <section class="form-section">
                <h2>OCR Regions</h2>
                <p class="section-help">Define screen regions to extract text from. Click "Capture Screen" then draw rectangles on the image.</p>

                <div class="capture-controls">
                    <button type="button" class="btn btn-primary" onclick="captureScreen()">
                        Capture Current Screen
                    </button>
                    <span id="captureStatus"></span>
                </div>

                <div id="screenPreview" class="screen-preview">
                    <p class="placeholder-text">Click "Capture Screen" to begin</p>
                </div>

                <div id="regionList" class="region-list">
                    <h3>Defined Regions</h3>
                    <div id="regionsContainer">
                        {% if job and job.ocr_regions %}
                            {% for region in job.ocr_regions %}
                            <div class="region-item" data-index="{{ loop.index0 }}">
                                <strong>{{ region.name }}</strong>
                                <span>({{ region.x }}, {{ region.y }}, {{ region.width }}x{{ region.height }})</span>
                                <button type="button" class="btn btn-small btn-danger" onclick="deleteRegion({{ loop.index0 }})">Delete</button>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="no-regions">No regions defined. Capture screen and draw regions.</p>
                        {% endif %}
                    </div>
                </div>
            </section>

            <!-- Page Handling -->
            <section class="form-section">
                <h2>Page Handling</h2>

                <div class="form-group">
                    <label for="page_mode">Extraction Mode</label>
                    <select id="page_mode" name="page_mode" onchange="updatePageModeConfig()">
                        <option value="single" {{ 'selected' if not job or job.page_mode == 'single' else '' }}>Single Page</option>
                        <option value="scroll" {{ 'selected' if job and job.page_mode == 'scroll' else '' }}>Scroll to Load All</option>
                        <option value="pagination" {{ 'selected' if job and job.page_mode == 'pagination' else '' }}>Pagination (Click Next)</option>
                    </select>
                </div>

                <!-- Scroll Config -->
                <div id="scrollConfig" class="sub-config" style="display: none;">
                    <h4>Scroll Settings</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="max_scrolls">Max Scrolls</label>
                            <input type="number" id="max_scrolls" name="max_scrolls" value="{{ job.scroll_config.max_scrolls if job and job.scroll_config else 50 }}" min="1">
                        </div>
                        <div class="form-group">
                            <label for="scroll_wait">Wait Time (sec)</label>
                            <input type="number" id="scroll_wait" name="scroll_wait" value="{{ job.scroll_config.wait_time if job and job.scroll_config else 2 }}" min="0.5" step="0.5">
                        </div>
                        <div class="form-group">
                            <label for="scroll_pixels">Scroll Pixels</label>
                            <input type="number" id="scroll_pixels" name="scroll_pixels" value="{{ job.scroll_config.scroll_pixels if job and job.scroll_config else 500 }}" min="100">
                        </div>
                    </div>
                </div>

                <!-- Pagination Config -->
                <div id="paginationConfig" class="sub-config" style="display: none;">
                    <h4>Pagination Settings</h4>
                    <div class="form-group">
                        <label for="pagination_mode">Button Detection Mode</label>
                        <select id="pagination_mode" name="pagination_mode">
                            <option value="ocr" {{ 'selected' if not job or (job.pagination_config and job.pagination_config.get('mode') == 'ocr') else '' }}>OCR (Find button by text)</option>
                            <option value="coordinates" {{ 'selected' if job and job.pagination_config and job.pagination_config.get('mode') == 'coordinates' else '' }}>Fixed Coordinates</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="button_text">Button Text</label>
                            <input type="text" id="button_text" name="button_text" value="{{ job.pagination_config.button_text if job and job.pagination_config else 'Next' }}" placeholder="Next">
                        </div>
                        <div class="form-group">
                            <label for="max_pages">Max Pages</label>
                            <input type="number" id="max_pages" name="max_pages" value="{{ job.pagination_config.max_pages if job and job.pagination_config else 100 }}" min="1">
                        </div>
                    </div>
                </div>
            </section>

            <!-- Message Format -->
            <section class="form-section">
                <h2>Message Format</h2>

                <div class="form-group">
                    <label for="format_template">Telegram Message Template</label>
                    <textarea id="format_template" name="format_template" rows="4" placeholder="<b>Alert</b>&#10;&#10;Field 1: {region_name_1}&#10;Field 2: {region_name_2}">{{ job.format_template if job else '' }}</textarea>
                    <small>Use {region_name} placeholders. Supports HTML: &lt;b&gt;bold&lt;/b&gt;, &lt;i&gt;italic&lt;/i&gt;</small>
                </div>

                <div id="formatPreview" class="format-preview">
                    <h4>Preview</h4>
                    <div id="previewContent">Enter a template and test extraction to see preview</div>
                </div>
            </section>

            <!-- Telegram -->
            <section class="form-section">
                <h2>Telegram Configuration</h2>

                <div class="form-group">
                    <label for="telegram_bot_token">Bot Token</label>
                    <input type="text" id="telegram_bot_token" name="telegram_bot_token"
                           value="{{ job.telegram_bot_token if job else '' }}"
                           placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz">
                    <small>Get from @BotFather on Telegram</small>
                </div>

                <div class="form-group">
                    <label for="telegram_chat_id">Chat ID</label>
                    <input type="text" id="telegram_chat_id" name="telegram_chat_id"
                           value="{{ job.telegram_chat_id if job else '' }}"
                           placeholder="-100123456789">
                    <small>Channel/group ID (starts with -100 for channels)</small>
                </div>

                <button type="button" class="btn" onclick="testTelegram()">
                    Test Telegram Connection
                </button>
                <span id="telegramStatus"></span>
            </section>

            <!-- Test Extraction -->
            <section class="form-section">
                <h2>Test Extraction</h2>
                <p class="section-help">Test your configuration before saving</p>

                <button type="button" class="btn btn-primary" onclick="testExtraction()">
                    Run Test Extraction
                </button>

                <div id="testResults" class="test-results" style="display: none;">
                    <h4>Extraction Results</h4>
                    <pre id="testResultsContent"></pre>
                </div>
            </section>

            <!-- Schedule -->
            <section class="form-section">
                <h2>Schedule</h2>

                <div class="form-row">
                    <div class="form-group">
                        <label for="schedule_interval_hours">Run Every</label>
                        <div class="input-with-suffix">
                            <input type="number" id="schedule_interval_hours" name="schedule_interval_hours"
                                   value="{{ job.schedule_interval_hours if job else 1 }}" min="1">
                            <span>hours</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="active">Status</label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="active" name="active" {{ 'checked' if job and job.active else '' }}>
                            Active (job will run automatically)
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="enable_deduplication">Deduplication</label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="enable_deduplication" name="enable_deduplication"
                               {{ 'checked' if not job or job.enable_deduplication else '' }}>
                        Only send new data (skip duplicates)
                    </label>
                </div>
            </section>

            <!-- Submit -->
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-large">
                    {{ 'Update' if job else 'Create' }} Job
                </button>
                <a href="/" class="btn btn-large">Cancel</a>
            </div>
        </form>
    </div>

    <script src="/static/js/region_selector.js"></script>
    <script src="/static/js/action_editor.js"></script>
    <script>
        // Initialize with existing regions if editing
        {% if job and job.ocr_regions %}
        regions = {{ job.ocr_regions | tojson }};
        {% endif %}

        // Initialize with existing pre-extraction actions if editing
        {% if job and job.pre_extraction_actions %}
        preExtractionActions = {{ job.pre_extraction_actions | tojson }};
        updateActionsList();
        {% endif %}

        // Page mode config visibility
        function updatePageModeConfig() {
            const mode = document.getElementById('page_mode').value;
            document.getElementById('scrollConfig').style.display = mode === 'scroll' ? 'block' : 'none';
            document.getElementById('paginationConfig').style.display = mode === 'pagination' ? 'block' : 'none';
        }
        updatePageModeConfig();

        // Form submission
        document.getElementById('jobForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                name: document.getElementById('name').value,
                url: document.getElementById('url').value,
                ocr_regions: regions,
                pre_extraction_actions: preExtractionActions,
                format_template: document.getElementById('format_template').value,
                telegram_bot_token: document.getElementById('telegram_bot_token').value,
                telegram_chat_id: document.getElementById('telegram_chat_id').value,
                page_mode: document.getElementById('page_mode').value,
                scroll_config: {
                    max_scrolls: parseInt(document.getElementById('max_scrolls').value),
                    wait_time: parseFloat(document.getElementById('scroll_wait').value),
                    scroll_pixels: parseInt(document.getElementById('scroll_pixels').value)
                },
                pagination_config: {
                    mode: document.getElementById('pagination_mode').value,
                    button_text: document.getElementById('button_text').value,
                    max_pages: parseInt(document.getElementById('max_pages').value)
                },
                schedule_interval_hours: parseInt(document.getElementById('schedule_interval_hours').value),
                active: document.getElementById('active').checked,
                enable_deduplication: document.getElementById('enable_deduplication').checked
            };

            try {
                const jobId = {{ job.id if job else 'null' }};
                const url = jobId ? `/api/job/${jobId}` : '/api/job';
                const method = jobId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    window.location.href = '/';
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                alert('Error saving job: ' + e.message);
            }
        });

        // Test Telegram
        async function testTelegram() {
            const status = document.getElementById('telegramStatus');
            status.textContent = 'Testing...';
            status.className = '';

            try {
                const response = await fetch('/api/test-telegram', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        telegram_bot_token: document.getElementById('telegram_bot_token').value,
                        telegram_chat_id: document.getElementById('telegram_chat_id').value
                    })
                });

                const result = await response.json();

                if (result.success) {
                    status.textContent = `Connected as @${result.bot_username}. Check Telegram for test message!`;
                    status.className = 'status-success';
                } else {
                    status.textContent = 'Error: ' + result.error;
                    status.className = 'status-error';
                }
            } catch (e) {
                status.textContent = 'Error: ' + e.message;
                status.className = 'status-error';
            }
        }

        // Test extraction
        async function testExtraction() {
            const resultsDiv = document.getElementById('testResults');
            const content = document.getElementById('testResultsContent');

            resultsDiv.style.display = 'block';
            content.textContent = 'Running extraction...';

            try {
                const response = await fetch('/api/test-extraction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ocr_regions: regions,
                        format_template: document.getElementById('format_template').value
                    })
                });

                const result = await response.json();

                if (result.success) {
                    let output = 'EXTRACTED DATA:\n';
                    output += JSON.stringify(result.data, null, 2);
                    output += '\n\nCONFIDENCE SCORES:\n';
                    for (const [name, info] of Object.entries(result.results)) {
                        output += `  ${name}: ${(info.confidence * 100).toFixed(1)}%\n`;
                    }
                    if (result.formatted_message) {
                        output += '\nFORMATTED MESSAGE:\n' + result.formatted_message;
                    }
                    content.textContent = output;

                    // Update preview
                    if (result.formatted_message) {
                        document.getElementById('previewContent').innerHTML = result.formatted_message.replace(/\n/g, '<br>');
                    }
                } else {
                    content.textContent = 'Error: ' + result.error;
                }
            } catch (e) {
                content.textContent = 'Error: ' + e.message;
            }
        }
    </script>
</body>
</html>
